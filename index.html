<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRIP UA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --bg: #101010;
            --bg-card: #1a1a1a;
            --bg-card-hover: #222222;
            --text: #e8e8e8;
            --text-dim: #888888;
            --text-muted: #555555;
            --border: #1f1f1f;
            --card-radius: 14px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; background: rgba(255,255,255,0.8); border-radius: 50%; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translateY(-10px) translateX(0); opacity: 1; }
            25% { transform: translateY(25vh) translateX(15px); }
            50% { transform: translateY(50vh) translateX(-10px); opacity: 0.8; }
            75% { transform: translateY(75vh) translateX(20px); }
            100% { transform: translateY(105vh) translateX(-5px); opacity: 0; }
        }

        .header { position: sticky; top: 0; z-index: 100; background: rgba(16,16,16,0.92); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .header-inner { display: flex; align-items: center; justify-content: center; position: relative; }
        .back-btn { position: absolute; left: 0; display: flex; align-items: center; gap: 4px; background: none; border: none; color: var(--text-dim); font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 500; cursor: pointer; padding: 4px 0; }
        .back-btn svg { width: 20px; height: 20px; fill: var(--text-dim); }
        .back-btn:active { opacity: 0.6; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-mark { width: 36px; height: 36px; border-radius: 10px; background: #fff; display: flex; align-items: center; justify-content: center; }
        .logo-mark svg { width: 20px; height: 20px; fill: #101010; }
        .logo-text { font-size: 20px; font-weight: 800; letter-spacing: -0.3px; color: #fff; }
        .logo-text span { font-weight: 400; color: var(--text-dim); }

        .hero { padding: 48px 24px 32px; text-align: center; }
        .hero-badge { display: inline-block; padding: 6px 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); border-radius: 100px; font-size: 12px; color: var(--text-dim); letter-spacing: 0.5px; margin-bottom: 20px; }
        .hero h1 { font-size: 32px; font-weight: 900; line-height: 1.15; letter-spacing: -0.5px; color: #fff; margin-bottom: 10px; }
        .hero p { font-size: 15px; color: var(--text-muted); line-height: 1.5; max-width: 300px; margin: 0 auto; }

        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 28px 20px 16px; }
        .section-title { font-size: 13px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); }
        .item-count { font-size: 12px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 20px; }

        .card-list { padding: 0 16px 120px; display: flex; flex-direction: column; gap: 8px; }
        .card { display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-card); border-radius: var(--card-radius); border: 1px solid var(--border); cursor: pointer; transition: background 0.15s ease, transform 0.15s ease; text-decoration: none; color: inherit; -webkit-user-select: none; user-select: none; opacity: 0; transform: translateY(16px); }
        .card.visible { opacity: 1; transform: translateY(0); transition: opacity 0.4s ease, transform 0.4s ease, background 0.15s ease; }
        .card:active { background: var(--bg-card-hover); transform: scale(0.98) translateY(0) !important; }
        .card-icon { width: 50px; height: 50px; border-radius: 14px; background: rgba(255,255,255,0.04); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }
        .card-content { flex: 1; min-width: 0; }
        .card-name { font-size: 15px; font-weight: 600; color: #fff; margin-bottom: 3px; }
        .card-desc { font-size: 13px; color: var(--text-muted); }
        .card-arrow { flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; transition: background 0.15s ease; }
        .card:active .card-arrow { background: rgba(255,255,255,0.1); }
        .card-arrow svg { width: 16px; height: 16px; fill: var(--text-muted); }

        .view { display: none; }
        .view.active { display: block; }

        .footer { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: linear-gradient(to top, var(--bg) 50%, transparent); pointer-events: none; z-index: 50; }
        .footer p { font-size: 11px; color: var(--text-muted); letter-spacing: 0.3px; }
        .glow { position: absolute; top: -100px; left: 50%; transform: translateX(-50%); width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.025) 0%, transparent 70%); pointer-events: none; z-index: 0; }

        /* Review styles */
        .review-card { padding: 16px; background: var(--bg-card); border-radius: var(--card-radius); border: 1px solid var(--border); margin-bottom: 12px; opacity: 0; transform: translateY(16px); }
        .review-card.visible { opacity: 1; transform: translateY(0); transition: opacity 0.4s ease, transform 0.4s ease; }
        .review-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .review-shop { font-weight: 600; color: #fff; font-size: 15px; }
        .review-location { font-size: 12px; color: var(--text-muted); }
        .review-product { font-size: 13px; color: var(--text-dim); margin-bottom: 8px; }
        .review-text { font-size: 14px; line-height: 1.5; color: var(--text); margin-bottom: 8px; }
        .review-footer { display: flex; justify-content: space-between; align-items: center; }
        .review-author { font-size: 12px; color: var(--text-muted); }
        .review-rating { display: flex; gap: 2px; }
        .star { color: #ffd700; font-size: 14px; }
        .star.empty { color: var(--text-muted); }

        /* Form styles */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; }
        .form-input, .form-textarea { width: 100%; padding: 12px 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-family: 'Inter', sans-serif; font-size: 15px; }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: rgba(255,255,255,0.2); }
        .rating-selector { display: flex; gap: 8px; }
        .rating-btn { flex: 1; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; color: var(--text-dim); font-size: 18px; cursor: pointer; transition: all 0.2s; }
        .rating-btn.active { background: rgba(255,215,0,0.1); border-color: #ffd700; color: #ffd700; }
        .submit-btn { width: 100%; padding: 16px; background: #fff; color: #101010; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .submit-btn:active { opacity: 0.8; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
    </style>
</head>
<body>

    <div class="snow-container" id="snowContainer"></div>
    <div class="glow"></div>

    <!-- VIEW: REGIONS -->
    <div id="viewRegions" class="view active">
        <div class="header"><div class="header-inner">
            <div class="logo"><div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="logo-text">TRIP <span>UA</span></div></div>
        </div></div>
        <div class="hero">
            <div class="hero-badge">‚ùÑÔ∏è –ó–∏–º–∞ 2026</div>
            <h1>–û–±–µ—Ä–∏<br>–æ–±–ª–∞—Å—Ç—å</h1>
            <p>–ó–Ω–∞–π–¥–∏ –Ω–∞–π–∫—Ä–∞—â—ñ –º–∞–≥–∞–∑–∏–Ω–∏<br>—É —Å–≤–æ—î–º—É —Ä–µ–≥—ñ–æ–Ω—ñ</p>
        </div>
        <div class="section-header">
            <div class="section-title">–û–±–ª–∞—Å—Ç—ñ</div>
            <div class="item-count" id="regionCount"></div>
        </div>
        <div class="card-list" id="regionList"></div>
    </div>

    <!-- VIEW: CITIES -->
    <div id="viewCities" class="view">
        <div class="header"><div class="header-inner">
            <button class="back-btn" onclick="showRegions()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>–ù–∞–∑–∞–¥</button>
            <div class="logo"><div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="logo-text">TRIP <span>UA</span></div></div>
        </div></div>
        <div class="hero">
            <div class="hero-badge" id="citiesBadge"></div>
            <h1>–û–±–µ—Ä–∏<br>–º—ñ—Å—Ç–æ</h1>
            <p>–ú–∞–≥–∞–∑–∏–Ω–∏ —É –º—ñ—Å—Ç–∞—Ö<br>—Ç–≤–æ—î—ó –æ–±–ª–∞—Å—Ç—ñ</p>
        </div>
        <div class="section-header">
            <div class="section-title">–ú—ñ—Å—Ç–∞</div>
            <div class="item-count" id="cityCount"></div>
        </div>
        <div class="card-list" id="cityList"></div>
    </div>

    <!-- VIEW: SHOPS -->
    <div id="viewShops" class="view">
        <div class="header"><div class="header-inner">
            <button class="back-btn" onclick="showCities(currentRegionId)"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>–ù–∞–∑–∞–¥</button>
            <div class="logo"><div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="logo-text">TRIP <span>UA</span></div></div>
        </div></div>
        <div class="hero">
            <div class="hero-badge" id="shopsBadge"></div>
            <h1>–°–ø–∏—Å–æ–∫<br>–ú–∞–≥–∞–∑–∏–Ω—ñ–≤</h1>
            <p>–ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω—ñ –º–∞–≥–∞–∑–∏–Ω–∏ –∑ –Ω–∞–π–∫—Ä–∞—â–∏–º–∏<br>—Ç–æ–≤–∞—Ä–∞–º–∏ —Ç–∞ —Å–µ—Ä–≤—ñ—Å–æ–º</p>
        </div>
        <div class="section-header">
            <div class="section-title">–ú–∞–≥–∞–∑–∏–Ω–∏</div>
            <div class="item-count" id="shopCount"></div>
        </div>
        <div class="card-list" id="shopList"></div>
    </div>

    <!-- VIEW: REVIEWS -->
    <div id="viewReviews" class="view">
        <div class="header"><div class="header-inner">
            <button class="back-btn" onclick="showRegions()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>–ù–∞–∑–∞–¥</button>
            <div class="logo"><div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="logo-text">TRIP <span>UA</span></div></div>
        </div></div>
        <div class="hero">
            <div class="hero-badge">‚≠ê –í—ñ–¥–≥—É–∫–∏</div>
            <h1>–í—Å—ñ<br>–í—ñ–¥–≥—É–∫–∏</h1>
            <p>–©–∏—Ä—ñ –≤—ñ–¥–≥—É–∫–∏ –≤—ñ–¥ –Ω–∞—à–∏—Ö<br>–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>
        </div>
        <div class="section-header">
            <div class="section-title">–í—ñ–¥–≥—É–∫–∏</div>
            <div class="item-count" id="reviewCount"></div>
        </div>
        <div style="padding: 0 16px 16px;">
            <button onclick="showAddReview()" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; color: var(--text); font-size: 15px; font-weight: 600; cursor: pointer;">
                ‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏ –≤—ñ–¥–≥—É–∫
            </button>
        </div>
        <div class="card-list" id="reviewList"></div>
    </div>

    <!-- VIEW: ADD REVIEW -->
    <div id="viewAddReview" class="view">
        <div class="header"><div class="header-inner">
            <button class="back-btn" onclick="showRegions()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>–ù–∞–∑–∞–¥</button>
            <div class="logo"><div class="logo-mark"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></div><div class="logo-text">TRIP <span>UA</span></div></div>
        </div></div>
        <div class="hero">
            <div class="hero-badge">‚úçÔ∏è –ù–æ–≤–∏–π –≤—ñ–¥–≥—É–∫</div>
            <h1>–ó–∞–ª–∏—à–∏—Ç–∏<br>–í—ñ–¥–≥—É–∫</h1>
            <p>–ü–æ–¥—ñ–ª–∏—Å—å —Å–≤–æ—ó–º –¥–æ—Å–≤—ñ–¥–æ–º<br>–∑ —ñ–Ω—à–∏–º–∏</p>
        </div>
        <div style="padding: 0 20px 120px;">
            <div class="form-group">
                <label class="form-label">–ú–∞–≥–∞–∑–∏–Ω</label>
                <select class="form-input" id="reviewShopSelect">
                    <option value="">–û–±–µ—Ä—ñ—Ç—å –º–∞–≥–∞–∑–∏–Ω...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–ú—ñ—Å—Ç–æ</label>
                <select class="form-input" id="reviewCitySelect" disabled>
                    <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º–∞–≥–∞–∑–∏–Ω</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–æ–≤–∞—Ä</label>
                <input type="text" class="form-input" id="reviewProduct" placeholder="–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É..." maxlength="100">
            </div>
            <div class="form-group">
                <label class="form-label">–û—Ü—ñ–Ω–∫–∞</label>
                <div class="rating-selector">
                    <button class="rating-btn" onclick="setRating(1)">‚≠ê</button>
                    <button class="rating-btn" onclick="setRating(2)">‚≠ê‚≠ê</button>
                    <button class="rating-btn" onclick="setRating(3)">‚≠ê‚≠ê‚≠ê</button>
                    <button class="rating-btn" onclick="setRating(4)">‚≠ê‚≠ê‚≠ê‚≠ê</button>
                    <button class="rating-btn active" onclick="setRating(5)">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–í—ñ–¥–≥—É–∫</label>
                <textarea class="form-textarea" id="reviewText" placeholder="–û–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –¥–æ—Å–≤—ñ–¥..." maxlength="500"></textarea>
            </div>
            <button class="submit-btn" onclick="submitReview()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
        </div>
    </div>

    <div class="footer"><p>TRIP UA ¬∑ 2026</p></div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); tg.setHeaderColor('#101010'); tg.setBackgroundColor('#101010'); }

        // ===== CONFIG =====
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –¥–ª—è API
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ Telegram Mini App, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π origin
        // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º localhost:8080
        let API_BASE = window.location.origin;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
            API_BASE = 'http://localhost:8080';
        }
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ GitHub Pages –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ö–æ—Å—Ç–∏–Ω–≥ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞,
        // –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∑–¥–µ—Å—å:
        // API_BASE = 'http://your-vps-ip:8080';
        
        console.log('API_BASE:', API_BASE);
        
        // ===== DATA =====
        let data = { regions: [] };
        let reviews = [];
        let currentRating = 5;
        let reviewShopId = null;
        let reviewCityId = null;

        async function loadData() {
            try {
                const res = await fetch(`${API_BASE}/webapp_data.json`, { cache: 'no-store' });
                const json = await res.json();
                data = json && Array.isArray(json.regions) ? json : { regions: [] };
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è webapp_data.json', e);
                try {
                    const res = await fetch('webapp_data.json', { cache: 'no-store' });
                    const json = await res.json();
                    data = json && Array.isArray(json.regions) ? json : { regions: [] };
                } catch (e2) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ fallback', e2);
                    data = { regions: [] };
                }
            }
        }

        async function loadReviews() {
            try {
                const res = await fetch(`${API_BASE}/api/reviews?limit=500`, { cache: 'no-store' });
                const json = await res.json();
                reviews = json.reviews || [];
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–≥—É–∫—ñ–≤', e);
                reviews = [];
            }
        }

        let currentRegionId = null;
        const arrowSvg = `<svg viewBox="0 0 24 24"><path d="M9.29 6.71a1 1 0 0 0 0 1.41L13.17 12l-3.88 3.88a1 1 0 1 0 1.41 1.41l4.59-4.59a1 1 0 0 0 0-1.41L10.7 6.7a1 1 0 0 0-1.41.01z"/></svg>`;

        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        function animateCards(containerId) {
            requestAnimationFrame(() => {
                document.getElementById(containerId).querySelectorAll('.card').forEach((c, i) => {
                    setTimeout(() => c.classList.add('visible'), i * 50);
                });
            });
        }

        function showRegions() {
            currentRegionId = null;
            switchView('viewRegions');
            if (tg) tg.BackButton.hide();
        }

        function showCities(regionId) {
            currentRegionId = regionId;
            const region = data.regions.find(r => r.id === regionId);
            if (!region) return;

            document.getElementById('citiesBadge').textContent = 'üìç ' + region.name;
            document.getElementById('cityCount').textContent = region.cities.length + ' –º—ñ—Å—Ç';
            document.getElementById('cityList').innerHTML = region.cities.map(city => `
                <div class="card" onclick="showShops('${regionId}','${city.id}')">
                    <div class="card-icon">${city.emoji}</div>
                    <div class="card-content">
                        <div class="card-name">${city.name}</div>
                        <div class="card-desc">${city.desc}</div>
                    </div>
                    <div class="card-arrow">${arrowSvg}</div>
                </div>
            `).join('');

            switchView('viewCities');
            animateCards('cityList');
            if (tg) { tg.BackButton.show(); tg.BackButton.onClick(showRegions); }
        }

        function showShops(regionId, cityId) {
            currentRegionId = regionId;
            const region = data.regions.find(r => r.id === regionId);
            const city = region?.cities.find(c => c.id === cityId);
            if (!city) return;

            document.getElementById('shopsBadge').textContent = 'üìç ' + city.name;
            document.getElementById('shopCount').textContent = city.shops.length + ' –º—ñ—Å—Ü—å';
            document.getElementById('shopList').innerHTML = city.shops.map(shop => `
                <div class="card">
                    <a href="${shop.telegram}" target="_blank" rel="noopener" style="display: flex; align-items: center; gap: 14px; flex: 1; text-decoration: none; color: inherit;">
                        <div class="card-icon">${shop.emoji}</div>
                        <div class="card-content">
                            <div class="card-name">${shop.name}</div>
                            <div class="card-desc">${shop.desc}</div>
                        </div>
                    </a>
                    <button onclick="selectShopForReview('${shop.id}', '${cityId}')" style="background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; color: var(--text-dim); font-size: 12px; cursor: pointer; margin-left: 8px;">‚úçÔ∏è</button>
                </div>
            `).join('');

            switchView('viewShops');
            animateCards('shopList');
            if (tg) { tg.BackButton.show(); tg.BackButton.onClick(() => showCities(regionId)); }
        }

        function selectShopForReview(shopId, cityId) {
            reviewShopId = shopId.replace('shop_', '');
            reviewCityId = cityId.replace('city_', '');
            showAddReview();
        }

        function selectShopForReviewFromList() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞
            showRegions();
            setTimeout(() => {
                alert('–û–±–µ—Ä—ñ—Ç—å –º–∞–≥–∞–∑–∏–Ω –∑—ñ —Å–ø–∏—Å–∫—É —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ‚úçÔ∏è');
            }, 500);
        }

        async function showReviews() {
            switchView('viewReviews');
            await loadReviews();
            renderReviews();
            if (tg) { tg.BackButton.show(); tg.BackButton.onClick(showRegions); }
        }

        function renderReviews() {
            const count = reviews.length;
            document.getElementById('reviewCount').textContent = count + ' –≤—ñ–¥–≥—É–∫—ñ–≤';
            
            if (count === 0) {
                document.getElementById('reviewList').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚≠ê</div>
                        <p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</p>
                        <p style="margin-top: 8px; font-size: 13px;">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä—à–∏–º!</p>
                    </div>
                `;
                return;
            }

            document.getElementById('reviewList').innerHTML = reviews.map(review => {
                const stars = '‚≠ê'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
                const date = new Date(review.created_at).toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
                return `
                    <div class="review-card">
                        <div class="review-header">
                            <div style="flex: 1;">
                                <div class="review-shop">${review.shop_name}</div>
                                <div class="review-location">${review.city_name}, ${review.region_name}</div>
                            </div>
                            <div class="review-rating">${stars}</div>
                        </div>
                        <div class="review-product">üì¶ ${review.product_name}</div>
                        <div class="review-text">${escapeHtml(review.review_text)}</div>
                        <div class="review-footer">
                            <div class="review-author">üë§ ${review.user_name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${date}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            animateCards('reviewList');
        }

        function showAddReview() {
            switchView('viewAddReview');
            populateShopSelect();
            if (tg) { tg.BackButton.show(); tg.BackButton.onClick(showRegions); }
        }

        function populateShopSelect() {
            const select = document.getElementById('reviewShopSelect');
            select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –º–∞–≥–∞–∑–∏–Ω...</option>';
            
            data.regions.forEach(region => {
                region.cities.forEach(city => {
                    city.shops.forEach(shop => {
                        const option = document.createElement('option');
                        option.value = `${shop.id}|${city.id}`;
                        option.textContent = `${shop.name} (${city.name}, ${region.name})`;
                        select.appendChild(option);
                    });
                });
            });

            // –ï—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω —É–∂–µ –≤—ã–±—Ä–∞–Ω, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ
            if (reviewShopId && reviewCityId) {
                const value = `shop_${reviewShopId}|city_${reviewCityId}`;
                select.value = value;
                document.getElementById('reviewCitySelect').disabled = false;
                
                // –ù–∞—Ö–æ–¥–∏–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
                let cityName = '';
                data.regions.forEach(region => {
                    region.cities.forEach(city => {
                        if (city.id === `city_${reviewCityId}`) {
                            cityName = city.name;
                        }
                    });
                });
                document.getElementById('reviewCitySelect').innerHTML = `<option value="${reviewCityId}" selected>${cityName}</option>`;
            }

            select.onchange = function() {
                if (this.value) {
                    const [shopId, cityId] = this.value.split('|');
                    reviewShopId = shopId.replace('shop_', '');
                    reviewCityId = cityId.replace('city_', '');
                    document.getElementById('reviewCitySelect').disabled = false;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
                    let cityName = '';
                    data.regions.forEach(region => {
                        region.cities.forEach(city => {
                            if (city.id === cityId) {
                                cityName = city.name;
                            }
                        });
                    });
                    document.getElementById('reviewCitySelect').innerHTML = `<option value="${reviewCityId}" selected>${cityName}</option>`;
                } else {
                    reviewShopId = null;
                    reviewCityId = null;
                    document.getElementById('reviewCitySelect').disabled = true;
                    document.getElementById('reviewCitySelect').innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º–∞–≥–∞–∑–∏–Ω</option>';
                }
            };
        }

        function setRating(rating) {
            currentRating = rating;
            document.querySelectorAll('.rating-btn').forEach((btn, i) => {
                if (i + 1 === rating) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        async function submitReview() {
            const shopId = reviewShopId;
            const cityId = reviewCityId;
            const productName = document.getElementById('reviewProduct').value.trim();
            const reviewText = document.getElementById('reviewText').value.trim();

            if (!shopId || !cityId || !productName || !reviewText) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ Telegram WebApp —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            let userId = null;
            if (tg) {
                // –°–ø–æ—Å–æ–± 1: —á–µ—Ä–µ–∑ initDataUnsafe
                if (tg.initDataUnsafe?.user?.id) {
                    userId = tg.initDataUnsafe.user.id;
                }
                // –°–ø–æ—Å–æ–± 2: —á–µ—Ä–µ–∑ initData (–µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
                if (!userId && tg.initData) {
                    try {
                        const initData = new URLSearchParams(tg.initData);
                        const userStr = initData.get('user');
                        if (userStr) {
                            const user = JSON.parse(decodeURIComponent(userStr));
                            userId = user.id;
                        }
                    } catch (e) {
                        console.error('–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É initData', e);
                    }
                }
            }

            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å user_id, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏
            if (!userId) {
                userId = Math.floor(Date.now() / 1000); // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
                console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ user_id, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç–∏–º—á–∞—Å–æ–≤–∏–π ID:', userId);
            }

            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';

            try {
                const requestData = {
                    user_id: userId,
                    shop_id: parseInt(shopId),
                    city_id: parseInt(cityId),
                    product_name: productName,
                    review_text: reviewText,
                    rating: currentRating
                };

                console.log('–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—ñ–¥–≥—É–∫—É:', requestData);

                const res = await fetch(`${API_BASE}/api/reviews`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('–í—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞:', res.status, res.statusText);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    let errorMsg = '–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.error || errorMsg;
                    } catch (e) {
                        errorMsg = errorText || `HTTP ${res.status}`;
                    }
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + errorMsg);
                    return;
                }

                const result = await res.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç:', result);

                if (result.success) {
                    alert('‚úÖ –í—ñ–¥–≥—É–∫ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!');
                    document.getElementById('reviewProduct').value = '';
                    document.getElementById('reviewText').value = '';
                    setRating(5);
                    reviewShopId = null;
                    reviewCityId = null;
                    document.getElementById('reviewShopSelect').value = '';
                    document.getElementById('reviewCitySelect').disabled = true;
                    showRegions();
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
                }
            } catch (e) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É', e);
                let errorMsg = '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≤—ñ–¥–≥—É–∫—É. ';
                if (e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                    errorMsg += '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∞–±–æ —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
                } else {
                    errorMsg += e.message || '–°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
                }
                alert(errorMsg);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–≥—É–∫';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderRegions() {
            const regions = Array.isArray(data.regions) ? data.regions : [];
            document.getElementById('regionCount').textContent = regions.length + ' –æ–±–ª.';
            document.getElementById('regionList').innerHTML = regions.map(r => `
                <div class="card" onclick="showCities('${r.id}')">
                    <div class="card-icon">${r.emoji}</div>
                    <div class="card-content">
                        <div class="card-name">${r.name}</div>
                        <div class="card-desc">${r.desc}</div>
                    </div>
                    <div class="card-arrow">${arrowSvg}</div>
                </div>
            `).join('');
            animateCards('regionList');
        }

        function createSnow() {
            const c = document.getElementById('snowContainer');
            for (let i = 0; i < 45; i++) {
                const f = document.createElement('div');
                f.classList.add('snowflake');
                const s = Math.random() * 3 + 1;
                f.style.width = s+'px'; f.style.height = s+'px';
                f.style.left = Math.random()*100+'%';
                f.style.animationDuration = (Math.random()*8+6)+'s';
                f.style.animationDelay = (Math.random()*12)+'s';
                f.style.opacity = Math.random()*0.4+0.15;
                c.appendChild(f);
            }
        }

        (async () => {
            createSnow();
            await loadData();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä view –≤ URL
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            
            if (view === 'reviews') {
                await showReviews();
            } else {
                renderRegions();
            }
        })();
    </script>
</body>
</html>
